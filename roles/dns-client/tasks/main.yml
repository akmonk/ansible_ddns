---
# tasks file for epel-release setup
- name: Install epel-release
  yum:
    pkg: epel-release
    state: installed

- name: Install bind-utils nginx
  yum:
    name:
      - bind-utils
      - nginx

- name: Starting nginx
  service:
    name: nginx
    state: started
    enabled: yes

- name: Add 80 port access
  firewalld:
    port: 80/tcp
    permanent: true
    state: enabled
    immediate: true

- name: Set hostname
  hostname:
    name: "{{ host_name }}"

- name: Set hostname fact
  set_fact:
    ansible_fqdn: "{{ host_name }}"

- name: Add dns-master to resolv.conf
  lineinfile: 
    dest: /etc/resolv.conf
    state: present
    line: 'nameserver {{ dns_master_ip }}'
    insertbefore: BOF

- name: Copy master key file
  copy:
    src: /root/ansible_tmp/{{domain}}_vault.key
    dest: /root/{{domain}}_vault.key
    owner: root
    group: root
    mode: 0600

- name: Copy master private file
  copy:
    src: /root/ansible_tmp/{{domain}}_vault.private
    dest: /root/{{domain}}_vault.private
    owner: root
    group: root
    mode: 0600

- name: Copy nsupdate script
  template:
    src: nsupdate.sh.j2
    dest: /root/nsupdate.sh
    owner: root
    group: root
    mode: 0700

- name: Copy info
  template:
    src: dns-client.txt.j2
    dest: /root/dns-client.txt
    owner: root
    group: root
    mode: 0700

- name: nsupdate execute
  command: /root/nsupdate.sh /root/dns-client.txt
  register: command_result

